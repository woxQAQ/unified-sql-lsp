# ============================================================================
# JOIN Completion Tests
# ============================================================================
# Tests for JOIN-related completions including ON conditions and foreign keys
# Context: orders.user_id references users.id, order_items references orders and products

---
description: JOIN type keywords
dialect: all
input: |
  SELECT * FROM users |
expected: |
  INNER [Keyword]
  LEFT [Keyword]
  RIGHT [Keyword]
  CROSS [Keyword]
  FULL [Keyword]
  JOIN [Keyword]
  AS [Keyword]
  WHERE [Keyword]
  GROUP [Keyword]
  ORDER [Keyword]
options: |
  contains: INNER, LEFT, RIGHT, CROSS, JOIN

---
description: Table name after JOIN
dialect: all
input: |
  SELECT * FROM users JOIN |
expected: |
  orders [Table]
  posts [Table]
  products [Table]
  order_items [Table]
  employees [Table]
options: |
  min_items: 5

---
description: ON keyword after JOIN
dialect: all
input: |
  SELECT * FROM users u JOIN orders o |
expected: |
  ON [Keyword]
  AS [Keyword]
  USING [Keyword]
options: |
  contains: ON

---
description: Column completion in ON condition (left side)
dialect: all
context: orders.user_id is a foreign key referencing users.id
input: |
  SELECT * FROM orders o JOIN users u ON o.| = u.id
expected: |
  user_id [Field] o.user_id
  id [Field] o.id
  order_date [Field] o.order_date
  total_amount [Field] o.total_amount
  status [Field] o.status
options: |
  contains: user_id
  min_items: 5

---
description: Foreign key column should appear first in ON
dialect: all
context: orders.user_id is a foreign key referencing users.id
input: |
  SELECT * FROM orders o JOIN users u ON o.| = u.id
expected: |
  user_id [Field] o.user_id
options: |
  contains: user_id

---
description: Column completion in ON condition (right side)
dialect: all
input: |
  SELECT * FROM orders o JOIN users u ON o.user_id = u.|
expected: |
  id [Field] u.id
  username [Field] u.username
  email [Field] u.email
options: |
  min_items: 3

---
description: Primary key column prioritized in ON
dialect: all
context: users.id is primary key
input: |
  SELECT * FROM orders o JOIN users u ON o.user_id = u.|
expected: |
  id [Field] u.id
options: |
  contains: id

---
description: Multiple JOINs - second ON condition
dialect: all
input: |
  SELECT * FROM users u JOIN orders o ON u.id = o.user_id JOIN order_items oi ON o.| = oi.order_id
expected: |
  id [Field] o.id
  user_id [Field] o.user_id
options: |
  contains: id

---
description: USING clause with column names
dialect: all
input: |
  SELECT * FROM orders o JOIN users u USING (|
expected: |
  user_id [Field] user_id
options: |
  min_items: 1

---
description: Complex JOIN with aliases
dialect: all
input: |
  SELECT * FROM users AS u JOIN orders AS o |
expected: |
  ON [Keyword]
  USING [Keyword]
  AS [Keyword]
options: |
  contains: ON

---
description: Self-join column completion
dialect: all
context: employees.manager_id references employees.id
input: |
  SELECT * FROM employees e1 JOIN employees e2 ON e1.| = e2.id
expected: |
  manager_id [Field] e1.manager_id
  id [Field] e1.id
  department [Field] e1.department
options: |
  contains: manager_id, id

---
description: Ambiguous column handling - left side
dialect: all
context: Both users and orders have id column
input: |
  SELECT * FROM users u JOIN orders o ON u.|
expected: |
  id [Field] u.id
  username [Field] u.username
  email [Field] u.email
options: |
  min_items: 3

---
description: Ambiguous column handling - right side
dialect: all
context: Both users and orders have id column
input: |
  SELECT * FROM users u JOIN orders o ON u.id = o.|
expected: |
  id [Field] o.id
  user_id [Field] o.user_id
  order_date [Field] o.order_date
options: |
  min_items: 3

---
description: Three-way JOIN completion
dialect: all
input: |
  SELECT * FROM users u JOIN orders o ON u.id = o.user_id JOIN order_items oi ON o.id = oi.order_id JOIN |
expected: |
  products [Table]
  posts [Table]
  tags [Table]
options: |
  min_items: 3

---
description: LEFT OUTER JOIN (full keyword)
dialect: all
input: |
  SELECT * FROM users LEFT OUTER |
expected: |
  JOIN [Keyword]
options: |
  contains: JOIN

---
description: FULL OUTER JOIN (PostgreSQL)
dialect: postgresql
input: |
  SELECT * FROM users FULL OUTER |
expected: |
  JOIN [Keyword]
options: |
  contains: JOIN

---
description: JOIN with multiple ON conditions (AND)
dialect: all
input: |
  SELECT * FROM orders o JOIN users u ON o.user_id = u.id AND |
expected: |
  o [Table]
  u [Table]
  o.id [Field]
  o.status [Field]
  u.is_active [Field]
options: |
  min_items: 5

---
description: JOIN ON with expression
dialect: all
input: |
  SELECT * FROM orders o JOIN users u ON o.| > 0
expected: |
  id [Field] o.id
  user_id [Field] o.user_id
  total_amount [Field] o.total_amount
options: |
  min_items: 3

---
description: Chain JOIN completion
dialect: all
input: |
  SELECT * FROM orders o JOIN order_items oi ON o.id = oi.order_id JOIN products p ON |
expected: |
  oi.product_id [Field]
  p.id [Field]
options: |
  min_items: 2

---
description: Many-to-many JOIN through junction table
dialect: all
context: post_tags connects posts and tags
input: |
  SELECT * FROM posts p JOIN post_tags pt ON p.id = pt.post_id JOIN |
expected: |
  tags [Table]
  users [Table]
options: |
  contains: tags

---
description: Alias qualified column in second ON
dialect: all
input: |
  SELECT * FROM users u JOIN orders o ON u.id = o.user_id JOIN order_items oi ON |.order_id = oi.order_id
expected: |
  o [Table]
  orders [Table]
options: |
  min_items: 2
