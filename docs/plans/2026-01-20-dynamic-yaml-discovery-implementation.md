# Dynamic YAML Test Discovery Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Implement automatic YAML test file discovery for the E2E test suite, eliminating manual test list maintenance in procedural macros.

**Architecture:**
- build.rs walks tests/ directories at compile time, generates test_discovery.rs
- Procedural macro includes discovery data, generates glob-based test functions
- Test runtime uses glob crate to discover YAML files dynamically
- Runtime validation ensures clear error messages for invalid files

**Tech Stack:**
- Rust procedural macros (proc-macro2, quote, syn)
- glob crate for runtime file discovery
- build.rs for compile-time directory walking
- serde_yaml for validation

---

## Task 1: Update build.rs Discovery Logic

**Files:**
- Modify: `tests/e2e-rs/core-macros/build.rs`

**Step 1: Replace current build.rs content**

Open `tests/e2e-rs/core-macros/build.rs` and replace entire content with:

```rust
// Copyright (c) 2025 woxQAQ
//
// Licensed under the MIT License or Apache License 2.0
// See LICENSE files for details

//! Build script for E2E test macros
//!
//! This build script discovers test directory structure at compile time,
//! enabling dynamic YAML test file discovery without manual configuration.

use std::env;
use std::fs;
use std::path::Path;

fn main() {
    let manifest_dir = env::var("CARGO_MANIFEST_DIR").unwrap();
    let tests_dir = Path::new(&manifest_dir).join("tests");

    // Discover all engine directories (mysql-5.7, mysql-8.0, postgresql-12, etc.)
    let engines = discover_engines(&tests_dir);

    // For each engine, discover test type directories (completion, hover, diagnostics)
    let discovery: Vec<(String, Vec<String>)> = engines
        .iter()
        .map(|engine| {
            let test_types = discover_test_types(&tests_dir.join(engine));
            (engine.clone(), test_types)
        })
        .collect();

    // Generate test_discovery.rs with directory structure
    let generated_code = generate_discovery_code(&discovery);
    let output_path = tests_dir.join("test_discovery.rs");

    fs::write(&output_path, generated_code)
        .expect("Failed to write test_discovery.rs");

    // Tell cargo to track the tests directory for changes
    println!("cargo:rerun-if-changed=tests/");

    // Optional: Print debug info in development builds
    if env::var("DEBUG").is_ok() {
        println!("cargo:warning=Discovered {} engines", engines.len());
        for (engine, test_types) in &discovery {
            println!("cargo:warning=  {}: {:?}", engine, test_types);
        }
    }
}

/// Discover all engine directories under tests/
fn discover_engines(tests_dir: &Path) -> Vec<String> {
    fs::read_dir(tests_dir)
        .unwrap_or_else(|e| panic!("Failed to read tests directory {:?}: {}", tests_dir, e))
        .filter_map(|entry| entry.ok())
        .filter(|entry| entry.path().is_dir())
        .map(|entry| entry.file_name().to_string_lossy().to_string())
        .collect()
}

/// Discover all test type directories under an engine directory
fn discover_test_types(engine_dir: &Path) -> Vec<String> {
    fs::read_dir(engine_dir)
        .unwrap_or_else(|e| panic!("Failed to read engine directory {:?}: {}", engine_dir, e))
        .filter_map(|entry| entry.ok())
        .filter(|entry| entry.path().is_dir())
        .map(|entry| entry.file_name().to_string_lossy().to_string())
        .collect()
}

/// Generate Rust code with discovery results
fn generate_discovery_code(discovery: &[(String, Vec<String>)]) -> String {
    let mut code = String::from("// Auto-generated by build.rs\n");
    code.push_str("// DO NOT EDIT\n\n");
    code.push_str("//! Test discovery data generated by build script\n");
    code.push_str("//! Contains mappings of engine -> test_types for dynamic test discovery\n\n");

    for (engine, test_types) in discovery {
        let const_name = to_const_name(engine);
        let test_types_array = format!(
            "&[{}]",
            test_types
                .iter()
                .map(|t| format!("\"{}\"", t))
                .collect::<Vec<_>>()
                .join(", ")
        );
        code.push_str(&format!(
            "pub const {}: &[&str] = {};\n",
            const_name, test_types_array
        ));
    }

    code
}

/// Convert engine name to const name (e.g., "mysql-5.7" -> "MYSQL_5_7")
fn to_const_name(engine: &str) -> String {
    engine.replace("-", "_").to_uppercase()
}
```

**Step 2: Test build.rs independently**

Run: `cd tests/e2e-rs/core-macros && cargo build`

Expected: Build succeeds, `test_discovery.rs` generated

**Step 3: Verify test_discovery.rs was generated correctly**

Run: `cat tests/e2e-rs/core-macros/tests/test_discovery.rs`

Expected output (example):
```rust
// Auto-generated by build.rs
// DO NOT EDIT

//! Test discovery data generated by build script
//! Contains mappings of engine -> test_types for dynamic test discovery

pub const MYSQL_5_7: &[&str] = &["completion", "hover", "diagnostics"];
pub const MYSQL_8_0: &[&str] = &["completion"];
pub const POSTGRESQL_12: &[&str] = &["completion"];
pub const POSTGRESQL_16: &[&str] = &["completion"];
```

**Step 4: Commit build.rs changes**

```bash
git add tests/e2e-rs/core-macros/build.rs
git add tests/e2e-rs/core-macros/tests/test_discovery.rs
git commit -m "feat: add dynamic directory discovery to build.rs

- Implement discover_engines() to find all engine directories
- Implement discover_test_types() to find test type subdirectories
- Generate test_discovery.rs with engine -> test_types mappings
- Track tests/ directory for cargo rebuilds on file changes

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 2: Add glob Dependency

**Files:**
- Modify: `tests/e2e-rs/core-macros/Cargo.toml`

**Step 1: Add glob dependency**

Open `tests/e2e-rs/core-macros/Cargo.toml` and add to dependencies section:

```toml
[dependencies]
proc-macro2 = "1.0"
quote = "1.0"
syn = { version = "2.0", features = ["full"] }
glob = "0.3"
```

**Step 2: Verify dependency resolves**

Run: `cd tests/e2e-rs/core-macros && cargo check`

Expected: Dependency resolves successfully, no errors

**Step 3: Commit dependency addition**

```bash
git add tests/e2e-rs/core-macros/Cargo.toml
git commit -m "feat: add glob dependency for runtime YAML discovery

Version 0.3 for runtime file pattern matching in test functions.

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 3: Update Macro Implementation

**Files:**
- Modify: `tests/e2e-rs/core-macros/src/lib.rs`

**Step 1: Remove hardcoded test lists**

In `tests/e2e-rs/core-macros/src/lib.rs`, delete lines 100-131 (the hardcoded test lists for mysql_57, mysql_80, postgresql_12, postgresql_16).

**Step 2: Add helper function to parse discovery data**

After the `derive_test_metadata` function, add new helper functions:

```rust
/// Parse test types from generated test_discovery.rs for a specific engine
fn parse_test_types(discovery_data: &str, engine_name: &str) -> Vec<String> {
    let const_name = engine_name.replace("-", "_").to_uppercase();

    // Parse the discovery data to extract test types
    // Example line: pub const MYSQL_5_7: &[&str] = &["completion", "hover", "diagnostics"];
    discovery_data
        .lines()
        .find(|line| line.starts_with(&format!("pub const {}:", const_name)))
        .and_then(|line| {
            line.split("=&[")
                .nth(1)
                .map(|rest| {
                    let array_part = rest.trim_end_matches("];");
                    array_part
                        .split("\",\"")
                        .map(|s| s.trim_matches('"').to_string())
                        .collect()
                })
        })
        .unwrap_or_else(|| {
            // Fallback if parsing fails - return empty vec
            Vec::new()
        })
}

/// Format engine name for use in paths (mysql_57 -> mysql-5.7)
fn format_engine_path(engine_name: &str) -> String {
    engine_name.replace("_", "-")
}
```

**Step 3: Update generate_engine_tests macro function**

Replace the entire `generate_engine_tests` function body (after line 25) with:

```rust
#[proc_macro]
pub fn generate_engine_tests(input: TokenStream) -> TokenStream {
    let input_str = input.to_string();

    // Parse engine name (keep existing logic)
    let engine_name = if input_str.contains("MySQL57") {
        "mysql_57"
    } else if input_str.contains("MySQL80") {
        "mysql_80"
    } else if input_str.contains("PostgreSQL12") {
        "postgresql_12"
    } else if input_str.contains("PostgreSQL16") {
        "postgresql_16"
    } else {
        "unknown"
    };

    let engine_enum_name = if input_str.contains("MySQL57") {
        "MySQL57"
    } else if input_str.contains("MySQL80") {
        "MySQL80"
    } else if input_str.contains("PostgreSQL12") {
        "PostgreSQL12"
    } else if input_str.contains("PostgreSQL16") {
        "PostgreSQL16"
    } else {
        "MySQL57"
    };

    // Include discovery data generated by build.rs
    let discovery_data = include_str!("../tests/test_discovery.rs");

    // Parse test types for this engine
    let test_types = parse_test_types(discovery_data, &format_engine_path(engine_name));

    let test_func_name = proc_macro2::Ident::new(
        &format!("test_{}", engine_name),
        proc_macro2::Span::call_site(),
    );
    let engine_ident = proc_macro2::Ident::new(
        engine_enum_name,
        proc_macro2::Span::call_site(),
    );

    // Generate glob patterns for each test type
    let glob_patterns: Vec<String> = test_types
        .iter()
        .map(|test_type| {
            format!("tests/{}/{}/*.yaml", format_engine_path(engine_name), test_type)
        })
        .collect();

    let glob_pattern_tokens: Vec<proc_macro2::Literal> = glob_patterns
        .iter()
        .map(|p| proc_macro2::Literal::string(p))
        .collect();

    let serial_key = proc_macro2::Ident::new(engine_name, proc_macro2::Span::call_site());

    let output = quote::quote! {
        #[cfg(test)]
        mod #test_func_name {
            use super::*;

            #[tokio::test]
            #[serial(#serial_key)]
            async fn #test_func_name() -> anyhow::Result<()> {
                use unified_sql_lsp_e2e_core::{Engine, ensure_engine_ready};
                let _guard = ensure_engine_ready(&Engine::#engine_ident).await?;

                let patterns = &[#(#glob_pattern_tokens),*];
                let mut test_count = 0;

                for pattern in patterns {
                    for entry in glob::glob(pattern).map_err(|e| anyhow::anyhow!("Invalid glob pattern: {}", e))? {
                        let yaml_path = entry.map_err(|e| anyhow::anyhow!("Failed to read path: {}", e))?;
                        println!("Running test: {}", yaml_path.display());

                        unified_sql_lsp_e2e_core::run_suite(yaml_path.to_str().unwrap())
                            .map_err(|e| anyhow::anyhow!("Test failed for {}: {}", yaml_path.display(), e))?;

                        test_count += 1;
                    }
                }

                println!("✓ Ran {} tests for {}", test_count, #engine_name);
                Ok(())
            }
        }
    };

    TokenStream::from(output)
}
```

**Step 4: Remove old TODO comment**

Delete lines 92-98 (the TODO comment about implementing dynamic discovery).

**Step 5: Update file header comments**

Update the module-level comment at line 6 to reflect new implementation:

```rust
//! Procedural macros for generating E2E tests from YAML files
//!
//! This macro uses dynamic YAML discovery via build.rs and glob patterns,
//! automatically discovering all test files without manual configuration.
```

**Step 6: Test macro expansion**

Run: `cd tests/e2e-rs/core-macros && cargo build`

Expected: Build succeeds, macro compiles without errors

**Step 7: Commit macro changes**

```bash
git add tests/e2e-rs/core-macros/src/lib.rs
git commit -m "feat: implement dynamic YAML test discovery in macro

- Add parse_test_types() helper to read build.rs discovery data
- Replace hardcoded test lists with dynamic glob-based generation
- Generate one test function per engine using glob patterns
- Remove TODO comment (dynamic discovery now implemented)
- Update module documentation

Changes:
- Deleted hardcoded test lists (lines 100-131)
- Added helper functions for parsing discovery data
- Updated generate_engine_tests to use glob patterns
- Each engine function now discovers YAML files at runtime

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 4: Verify Implementation with Existing Tests

**Files:**
- No file modifications (testing only)

**Step 1: Run MySQL 5.7 tests**

Run: `cd tests/e2e-rs && make test-e2e-mysql-5.7`

Expected: All existing MySQL 5.7 tests pass

**Step 2: Run MySQL 8.0 tests**

Run: `make test-e2e-mysql-8.0`

Expected: All existing MySQL 8.0 tests pass

**Step 3: Run PostgreSQL 12 tests**

Run: `make test-e2e-postgresql-12`

Expected: All existing PostgreSQL 12 tests pass

**Step 4: Run PostgreSQL 16 tests**

Run: `make test-e2e-postgresql-16`

Expected: All existing PostgreSQL 16 tests pass (may be minimal)

**Step 5: Verify test output shows dynamic discovery**

Check output for messages like:
```
Running test: /path/to/tests/mysql-5.7/completion/basic_select.yaml
Running test: /path/to/tests/mysql-5.7/completion/from_clause.yaml
...
✓ Ran 11 tests for mysql_57
```

**Step 6: Run all E2E tests**

Run: `make test-e2e`

Expected: All E2E tests pass across all engines

**Step 7: Commit successful verification (optional)**

If all tests pass:
```bash
git commit --allow-empty -m "test: verify dynamic YAML discovery works with all engines

All E2E tests passing with new dynamic discovery:
- MySQL 5.7: ✓
- MySQL 8.0: ✓
- PostgreSQL 12: ✓
- PostgreSQL 16: ✓

Tests now automatically discover YAML files without manual configuration.

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 5: Test Dynamic Discovery Behavior

**Files:**
- Create: `tests/e2e-rs/tests/mysql-5.7/completion/new_dynamic_test.yaml`
- Create: `tests/e2e-rs/tests/postgresql-12/completion/new_dynamic_test.yaml`

**Step 1: Create new MySQL 5.7 test file**

Run:
```bash
cat > tests/e2e-rs/tests/mysql-5.7/completion/new_dynamic_test.yaml << 'EOF'
description: Test dynamic YAML file discovery
tests:
  - query: "SELECT * FROM users"
    position: 20
    context:
      database: test_db
      schema: public
    expected:
      - label: "id"
        kind: Field
        detail: "INT"
      - label: "name"
        kind: Field
        detail: "VARCHAR(255)"
EOF
```

**Step 2: Rebuild macro (cargo should detect tests/ change)**

Run: `cd tests/e2e-rs/core-macros && cargo build`

Expected: build.rs reruns, test_discovery.rs regenerated

**Step 3: Run MySQL 5.7 tests - should include new file**

Run: `make test-e2e-mysql-5.7 2>&1 | grep "new_dynamic_test"`

Expected: Output shows "Running test: .../new_dynamic_test.yaml"

**Step 4: Verify test count increased**

Check test output for final count:
```
✓ Ran 12 tests for mysql_57  # Was 11, now 12 with new file
```

**Step 5: Create new PostgreSQL 12 test file**

Run:
```bash
cat > tests/e2e-rs/tests/postgresql-12/completion/new_dynamic_test.yaml << 'EOF'
description: Test PostgreSQL dynamic discovery
tests:
  - query: "SELECT id, name FROM users"
    position: 28
    context:
      database: test_db
    expected:
      - label: "id"
        kind: Field
      - label: "name"
        kind: Field
EOF
```

**Step 6: Run PostgreSQL 12 tests - should include new file**

Run: `make test-e2e-postgresql-12 2>&1 | grep "new_dynamic_test"`

Expected: Output shows "Running test: .../new_dynamic_test.yaml"

**Step 7: Clean up test files**

Run:
```bash
rm tests/e2e-rs/tests/mysql-5.7/completion/new_dynamic_test.yaml
rm tests/e2e-rs/tests/postgresql-12/completion/new_dynamic_test.yaml
```

**Step 8: Verify tests pass after cleanup**

Run:
```bash
cd tests/e2e-rs/core-macros && cargo build
make test-e2e-mysql-5.7
make test-e2e-postgresql-12
```

Expected: Tests pass, count returns to original (11 for MySQL 5.7)

**Step 9: Commit discovery behavior verification**

```bash
git add tests/e2e-rs/tests/
git commit --allow-empty -m "test: verify dynamic YAML discovery behavior

Verified that:
- Adding new YAML files auto-discovers them on rebuild
- Removing YAML files removes them from test run
- Test counts update correctly
- No manual configuration needed

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 6: Update Documentation

**Files:**
- Modify: `tests/e2e-rs/core-macros/src/lib.rs` (already done in Task 3)
- Modify: `CLAUDE.md` (optional, if E2E testing section needs update)

**Step 1: Review CLAUDE.md E2E testing section**

Check if section 5 (E2E Testing) mentions manual test configuration.

**Step 2: Update CLAUDE.md if needed**

If the documentation mentions adding tests to macro lists, update to reflect automatic discovery.

Example update (if needed):
```markdown
### Adding New E2E Tests

1. Create YAML test file in appropriate directory:
   - `tests/e2e-rs/tests/{engine}/{test-type}/{test-name}.yaml`
   - Example: `tests/e2e-rs/tests/mysql-5.7/completion/new_feature.yaml`

2. Rebuild the macro (cargo auto-detects tests/ changes):
   ```bash
   cd tests/e2e-rs/core-macros
   cargo build
   ```

3. Run tests - new file automatically discovered:
   ```bash
   make test-e2e-mysql-5.7
   ```

**Note:** No manual macro configuration needed - build.rs discovers directories automatically.
```

**Step 3: Update design document with implementation notes**

Add implementation notes to `docs/plans/2026-01-20-dynamic-yaml-test-discovery-design.md`:

```markdown
## Implementation Notes (Post-Implementation)

### Completed Tasks
- ✅ build.rs directory discovery implemented
- ✅ test_discovery.rs generation working
- ✅ Macro updated to use glob patterns
- ✅ All existing tests passing
- ✅ Dynamic discovery verified

### Deviations from Design
- [Note any changes made during implementation]

### Known Limitations
- None currently identified

### Future Work
- Runtime YAML validation (deferred to separate task)
```

**Step 4: Commit documentation updates**

```bash
git add CLAUDE.md docs/plans/2026-01-20-dynamic-yaml-test-discovery-design.md
git commit -m "docs: update E2E testing documentation for dynamic discovery

- Update CLAUDE.md to reflect automatic YAML discovery
- Remove references to manual test configuration
- Add implementation notes to design document

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 7: Final Verification and Cleanup

**Files:**
- No file modifications (verification only)

**Step 1: Run full test suite**

Run: `make test-e2e`

Expected: All E2E tests pass across all engines

**Step 2: Run workspace unit tests**

Run: `cargo test --workspace --exclude '*-e2e-tests'`

Expected: All unit tests pass

**Step 3: Check for unused dependencies**

Run: `cd tests/e2e-rs/core-macros && cargo +nightly udeps`

If available and shows `glob` is unused, verify it's actually used in generated code.

**Step 4: Run clippy**

Run: `cd tests/e2e-rs/core-macros && cargo clippy`

Expected: No clippy warnings (or fix any that appear)

**Step 5: Format code**

Run: `cd tests/e2e-rs/core-macros && cargo fmt`

**Step 6: Verify git history**

Run: `git log --oneline --graph`

Expected: Clean commit history showing:
- build.rs changes
- dependency addition
- macro updates
- testing verification
- documentation updates

**Step 7: Create summary commit**

```bash
git commit --allow-empty -m "feat: complete dynamic YAML test discovery implementation

Summary of changes:
- build.rs: Directory discovery → test_discovery.rs generation
- Macro: Dynamic glob-based test generation
- Dependency: Added glob crate for runtime discovery
- Testing: All existing tests pass, dynamic discovery verified
- Documentation: Updated to reflect automatic discovery

Benefits:
✅ Add YAML file → rebuild → auto-discovered
✅ Zero manual configuration for new tests
✅ Clear test output with file paths
✅ Backward compatible with existing infrastructure

Resolves: tests/e2e-rs/core-macros/src/lib.rs:92-98 TODO

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Success Criteria

After completing all tasks:

- [ ] build.rs discovers engine and test type directories
- [ ] test_discovery.rs generated correctly with mappings
- [ ] Macro generates glob-based test functions
- [ ] All existing E2E tests pass without modification
- [ ] Adding new YAML file auto-discovers on rebuild
- [ ] Removing YAML file removes from test run
- [ ] No clippy warnings
- [ ] Code formatted
- [ ] Documentation updated
- [ ] Clean git history with logical commits

---

## Testing Commands Reference

```bash
# Build and verify build.rs discovery
cd tests/e2e-rs/core-macros && cargo build
cat tests/test_discovery.rs

# Test specific engine
make test-e2e-mysql-5.7
make test-e2e-mysql-8.0
make test-e2e-postgresql-12
make test-e2e-postgresql-16

# Test all engines
make test-e2e

# Unit tests
cargo test --workspace --exclude '*-e2e-tests'

# Linting
cargo clippy
cargo fmt

# Check dependencies (if nightly available)
cargo +nightly udeps
```

---

## Rollback Plan

If implementation fails:

1. **During Task 1-3:** Revert to main branch, restart worktree
2. **After Task 3:** Use `git revert` to undo macro changes
3. **After completion:** Feature branch isolated, main branch unaffected

To rollback completely:
```bash
cd ..
git worktree remove .worktrees/dynamic-yaml-discovery
git branch -D feature/dynamic-yaml-discovery
```
